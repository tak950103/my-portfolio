## 排ガス計測システム

---

### 目的
船内の複数の排ガス測定・分析装置を統合的に制御・監視し、測定データをリアルタイムで収集・記録・出力する。
校正・測定・エラー監視など、分析装置の自動運転を実現

---

### 期間
2025年8月下旬～10月（第1期）

---

### 規模・体制
- エンドユーザー：大手物流企業（外国人船員や現地エンジニア等）
- 顧客：排ガス分析計メーカー
- 開発担当：１人（要件定義～試験まで一貫対応）

---

### 担当
- 見積
- 要件定義 ※
- 設計 ※
- 開発
- 各装置との組み合わせ試験（試験のメインは顧客側。不具合修正等の対応）
※ 顧客技術担当との調整を含む

---

### 技術
#### 言語/フレームワーク
- C#, WPF(.NET Framework 4.8)
	- MVVMアーキテクチャ
#### 通信プロトコル
- TCP/IP：排ガス分析計との通信
- UDP：排ガス分析計との通信
- Modbus(RS-485)：船内別システム（上位）へのデータ出力
#### その他
- JSON：設定情報等の管理
- CSV：HOST PC内でのデータ保存

---

### 主な機能
1. 装置の統合監視・制御
	- **多成分計測**：1秒周期でCO2、CH4、N2O、CO濃度値を取得し、UIにリアルタイム表示。閾値ルール等により採用する値を変更するなどのロジックもあり。
	- **状態監視とエラー処理**：1秒周期で各装置の動作状態（計測中/一時停止/校正中/通信エラー等）を監視し、Statusとして表示。通信エラーの場合、自動復帰機能を搭載。
	- **設定ウィンドウ**：測定パラメータ（待機時間や校正周期、分析計の使用状況等）を一元管理するウィンドウを提供。
2. リアルタイムデータ管理とModbus出力
	- **リアルタイムデータの集約**：複数の装置からの瞬時値を一元的に集約するリアルタイムデータハブを構築
	- **Modbus データマッピング**：リアルタイムデータを、設定ファイルに基づいてマッピングし、周期的に更新。装置の状態（測定中/エラー/非搭載）に応じて、ルールに基づく値を出力する機能を持つ
3. 自動校正周期の実装
	- **校正周期**：設定された周期でPurge→Zero/Span校正→Measure復帰のシーケンスを自動実行
	- **連動制御**：メイン装置の校正サイクルに合わせ、他の装置の校正サイクルを連動させる機能。それぞれの装置で設定された校正サイクルルール（メイン装置の校正のn回に1回校正する等）を基に校正を実行する。
	- **安定化待ち**：校正の終了後、測定値が安定するまでの設定された時間、値やステータスをルールに従い出力する機能。

---

### 工夫点
- 非同期処理と長期安定稼働への配慮：
	- 通信やロギングなどについて、`async/await`を使用し、メインUIスレッドをブロックしない。装置との応答遅延があってもUIの応答性に影響しない。
- 通信異常に対する自己修復機能：
	- ネットワーク障害等に対して、復旧するまで自動的に再接続を試行。
	- 装置がオフラインに切り替わった際や、一定時間データが未更新であった場合、再初期化シーケンスを実行。
- リソース解放によるメモリ負荷軽減：
	- バックグラウンドで動作するポーリングループは、`CancellationTokenSource`で制御。アプリ終了時や処理の中断時などに、実行中のタスクやタイマーをキャンセルし、リソースを解放する。
- ステータスコードの一元化：
	- 複数の異なる装置から取得した状態を、統一されたステータスコードに正規化するアダプタ層を実装し、これを通じて上位システムやCSVに出力する。
- UI/UXへの配慮
	- 設定ウィンドウの表示条件（各装置がPause状態のときのみ）や測定開始ボタンや校正ボタンの押下可能条件などを整理し、ユーザー操作の安定性を確保。
	- エンドユーザーが外国人船員のため、アプリ内の表記やログ等すべて英語表記